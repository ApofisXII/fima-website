on:
    push:
        branches:
            - main

name: ðŸš€ Deploy on production
jobs:
    web-deploy:
        name: ðŸ“¤ Symfony deploy
        runs-on: ubuntu-latest
        steps:
            - name: ðŸšš Get latest code
              uses: actions/checkout@v6

            - name: ðŸ“‚ Upload and sync files
              uses: SamKirkland/FTP-Deploy-Action@v4.3.5
              with:
                  server: ${{ secrets.PROD_SERVER }}
                  username: ${{ secrets.PROD_FTP_USERNAME }}
                  password: ${{ secrets.PROD_FTP_PASSWORD }}
                  server-dir: httpdocs/

            - name: ðŸ§¹ Composer, migrations, cache
              uses: appleboy/ssh-action@v0.1.4
              with:
                  script_stop: true
                  port: ${{ secrets.PROD_SSH_PORT }}
                  host: ${{ secrets.PROD_SERVER }}
                  username: ${{ secrets.PROD_SSH_USERNAME }}
                  key: ${{ secrets.FEDERICO_DEFAULT_SSH_KEY }}
                  script: |
                      cd httpdocs
                      composer install --no-dev --optimize-autoloader
                      php bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration
                      php bin/console cache:clear --env=prod
                      php bin/console asset-map:compile --env=prod
