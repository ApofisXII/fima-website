{% extends 'admin/base.html.twig' %}

{% block body %}

    <div class="gg-h1">{{ category ? 'Modifica' : 'Nuova' }} categoria notizia</div>

    <form id="page-form" method="post" action="{{ path('adminNewsCategoriesDetailSave') }}">
        <input type="hidden" name="categoryId" value="{{ category ? category.id : "0" }}">

        <div class="box multi-detail-box gg-form">
            <h3>{{ category ? (category.nameIt ~ ' / ' ~ category.nameEn) : 'Dettaglio categoria' }}</h3>

            <div class="gg-multilang-form">
                <div>
                    <label>Nome categoria (italiano)</label>
                    <input type="text" name="nameIt" placeholder="Nome categoria in italiano" value="{{ category ? category.nameIt }}" required>
                </div>

                <div>
                    <label>Nome categoria (inglese)</label>
                    <input type="text" name="nameEn" placeholder="Nome categoria in inglese" value="{{ category ? category.nameEn }}" required>
                </div>
            </div>

        </div>

        <div class="gg-btn-group">
            <button type="submit" class="gg-submit-btn hoverizzato">Salva categoria</button>
            {% if category %}
                <button id="delete-btn" type="button" class="gg-delete-btn hoverizzato">Elimina categoria</button>
            {% endif %}
        </div>

    </form>

    {% if category %}
        <div id="delete-modal" class="gg-modal" style="display: none;">
            <div class="gg-modal-content">
                <p>Confermi di voler eliminare questa categoria?</p>
                <div class="gg-modal-buttons">
                    <button id="confirm-delete" class="gg-modal-btn gg-modal-btn--danger">SÃ¬, elimina</button>
                    <button id="cancel-delete" class="gg-modal-btn gg-modal-btn--cancel">Annulla</button>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block js %}

    <script type="module">
        document.getElementById('page-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);

            const payload = {
                categoryId: parseInt(formData.get('categoryId')),
                nameIt: formData.get('nameIt'),
                nameEn: formData.get('nameEn')
            };

            fetch('{{ path('adminNewsCategoriesDetailSave') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(async response =>  {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message || 'Errore nel salvataggio');
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                location.href = "{{ path('adminNewsCategoriesList') }}";
            })
            .catch(error => {
                alert('Errore: ' + error.message);
            });
        });

        {% if category %}
        const modal = document.getElementById('delete-modal');
        const deleteBtn = document.getElementById('delete-btn');
        const confirmBtn = document.getElementById('confirm-delete');
        const cancelBtn = document.getElementById('cancel-delete');

        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            modal.style.display = 'flex';
        });

        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        confirmBtn.addEventListener('click', function() {
            modal.style.display = 'none';

            fetch('{{ path('adminNewsCategoriesDelete', {'categoryId': category.id}) }}', {
                method: 'DELETE'
            })
            .then(async response => {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message);
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                location.href = "{{ path('adminNewsCategoriesList') }}";
            });
        });
        {% endif %}
    </script>

{% endblock %}
