{% extends 'admin/base.html.twig' %}

{% block body %}

    <div class="gg-h1">{{ edition ? 'Modifica' : 'Nuova' }} edizione</div>

    <form id="page-form" method="post" action="{{ path('adminUrbinoEditionsDetailSave') }}">
        <input type="hidden" name="editionId" value="{{ edition ? edition.id : "0" }}">

        <div class="box multi-detail-box gg-form">
            <h3>{{ edition ? edition.editionName : 'Dettaglio edizione' }}</h3>

            <div class="gg-form-row gg-form-row--no-margin">
                <div class="course-form-field">
                    <label>Nome edizione</label>
                    <input type="text" name="editionName" placeholder="Nome edizione" value="{{ edition ? edition.editionName }}" required>
                </div>

                <div class="course-dates-wrapper">
                    <div class="course-date-field">
                        <label>Data di inizio</label>
                        <input type="date" name="dateStart" value="{{ edition and edition.dateStart ? edition.dateStart|date('Y-m-d') }}" required>
                    </div>

                    <div class="course-date-field">
                        <label>Data di fine</label>
                        <input type="date" name="dateEnd" value="{{ edition and edition.dateEnd ? edition.dateEnd|date('Y-m-d') }}" required>
                    </div>
                </div>
            </div>

            <div class="gg-form-row">
                <div class="gg-form-row__main">
                    <label>Link per form di iscrizione</label>
                    <input type="url" name="enrollmentLink" placeholder="https://..." value="{{ edition ? edition.enrollmentLink }}">
                </div>
                <div class="course-date-field">
                    <label>Scadenza iscrizioni</label>
                    <input type="datetime-local" name="enrollmentDeadline" value="{{ edition and edition.enrollmentDeadline ? edition.enrollmentDeadline|date('Y-m-d\\TH:i') }}">
                </div>
            </div>

            <div class="gg-checkbox-group">
                <label>
                    <input type="checkbox" name="isPublicVisible" value="1" {{ edition and edition.isPublicVisible ? 'checked' }}>
                    <span>Edizione visibile pubblicamente</span>
                </label>
            </div>

        </div>

        <div class="box multi-detail-box gg-form">
            <h3>Informazioni per i partecipanti</h3>

            <div class="gg-multilang-form">
                <div class="gg-form-row gg-form-row--two">
                    <div class="gg-form-row__main">
                        <label>Informazioni - iscrizione e alloggio (italiano)</label>
                        <textarea name="enrollmentInfoIt" class="tiny-area" placeholder="Scrivi qui le informazioni per i partecipanti (italiano)">{{ edition ? edition.enrollmentInfoIt|raw }}</textarea>
                    </div>
                    <div class="gg-form-row__main">
                        <label>Informazioni - iscrizione e alloggio (inglese)</label>
                        <textarea name="enrollmentInfoEn" class="tiny-area" placeholder="Scrivi qui le informazioni per i partecipanti (inglese)">{{ edition ? edition.enrollmentInfoEn|raw }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        {% if edition %}
        <div class="box multi-detail-box gg-form">
            <h3>Programma dell'edizione (PDF)</h3>

            {% if edition.isProgrammePdfUploaded %}
                <p><a href="{{ asset('uploads-uma-edition/' ~ edition.id ~ '.pdf') }}" target="_blank">Visualizza PDF caricato</a></p>
            {% endif %}

            <label>Carica PDF</label>
            <input type="file" id="programme-pdf-input" accept="application/pdf">

            <div class="gg-action-btn-group">
                <button type="button" id="upload-pdf-btn" class="gg-action-btn hoverizzato">Salva PDF</button>
                {% if edition.isProgrammePdfUploaded %}
                    <button type="button" id="delete-pdf-btn" class="gg-action-btn gg-action-btn--delete hoverizzato">Elimina PDF</button>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="gg-btn-group">
            <button type="submit" class="gg-submit-btn hoverizzato">Salva edizione</button>
            {% if edition %}
                <button id="delete-btn" class="gg-delete-btn hoverizzato">Elimina edizione</button>
            {% endif %}
        </div>

    </form>

    {% if edition %}
        <div id="delete-modal" class="gg-modal" style="display: none;">
            <div class="gg-modal-content">
                <p>Confermi di voler eliminare questa edizione?</p>
                <div class="gg-modal-buttons">
                    <button id="confirm-delete" class="gg-modal-btn gg-modal-btn--danger">SÃ¬, elimina</button>
                    <button id="cancel-delete" class="gg-modal-btn gg-modal-btn--cancel">Annulla</button>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block js %}

    <script src="https://cdn.tiny.cloud/1/{{ tinymce_apikey }}/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>

    <script type="module">
        const fontUrl = '{{ asset("fonts/SofiaSans-VariableFont_wght.ttf") }}';
        tinymce.init({
            selector: '.tiny-area',
            menubar: false,
            toolbar: 'blocks | bold underline link bullist numlist removeformat',
            toolbar_mode: 'wrap',
            block_formats: 'Paragrafo=p; Titoletto=h2; Titoletto secondario=h3',
            plugins: 'link | lists | paste',
            branding: false,
            paste_as_text: true,
            statusbar: false,
            content_style: `@font-face { font-family: "Sofia Sans"; src: url("${fontUrl}") format("truetype"); font-weight: 100 900; } body { font-family: "Sofia Sans", sans-serif; background-color: #F3F5F9; } body[data-mce-placeholder]:not(.mce-visualblocks)::before { opacity: 0.5; color: #999; font-size: 0.9rem; }`,
        });

        document.getElementById('page-form').addEventListener('submit', function(e) {
            e.preventDefault();
            tinymce.triggerSave(true, true);

            const formData = new FormData(e.target);

            // Convert checkbox to boolean
            const isPublicVisible = formData.get('isPublicVisible') === '1';

            const payload = {
                editionId: formData.get('editionId'),
                editionName: formData.get('editionName'),
                dateStart: formData.get('dateStart'),
                dateEnd: formData.get('dateEnd'),
                isPublicVisible: isPublicVisible,
                enrollmentInfoIt: formData.get('enrollmentInfoIt'),
                enrollmentInfoEn: formData.get('enrollmentInfoEn'),
                enrollmentLink: formData.get('enrollmentLink') || null,
                enrollmentDeadline: formData.get('enrollmentDeadline') || null
            };

            fetch('{{ path('adminUrbinoEditionsDetailSave') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(async response =>  {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message || 'Errore nel salvataggio');
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                location.href = "{{ path('adminUrbinoEditionsList') }}";
            })
            .catch(error => {
                alert('Errore: ' + error.message);
            });
        });

        {% if edition %}
        const uploadPdfBtn = document.getElementById('upload-pdf-btn');
        const programmePdfInput = document.getElementById('programme-pdf-input');

        uploadPdfBtn.addEventListener('click', function() {
            if (!programmePdfInput.files || !programmePdfInput.files[0]) {
                alert('Seleziona prima un file PDF');
                return;
            }

            const formData = new FormData();
            formData.append('programmePdf', programmePdfInput.files[0]);

            fetch('{{ path('adminUrbinoEditionsUploadProgrammePdf', {'editionId': edition.id}) }}', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) { alert(data.message); return null; }
                return data;
            })
            .then(data => {
                if (data) location.reload();
            });
        });

        {% if edition.isProgrammePdfUploaded %}
        document.getElementById('delete-pdf-btn').addEventListener('click', function() {
            if (!confirm('Confermi di voler eliminare il PDF?')) return;

            fetch('{{ path('adminUrbinoEditionsDeleteProgrammePdf', {'editionId': edition.id}) }}', {
                method: 'DELETE'
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) { alert(data.message); return null; }
                return data;
            })
            .then(data => {
                if (data) location.reload();
            });
        });
        {% endif %}

        const modal = document.getElementById('delete-modal');
        const deleteBtn = document.getElementById('delete-btn');
        const confirmBtn = document.getElementById('confirm-delete');
        const cancelBtn = document.getElementById('cancel-delete');

        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            modal.style.display = 'flex';
        });

        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        confirmBtn.addEventListener('click', function() {
            modal.style.display = 'none';

            fetch('{{ path('adminUrbinoEditionsDelete', {'editionId': edition.id}) }}', {
                method: 'DELETE'
            })
            .then(async response => {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message);
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                location.href = "{{ path('adminUrbinoEditionsList') }}";
            });
        });
        {% endif %}
    </script>

{% endblock %}
