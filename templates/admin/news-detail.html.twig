{% extends 'admin/base.html.twig' %}

{% block body %}

    <div class="gg-h1">{{ news ? 'Modifica' : 'Nuova' }} notizia</div>

    <form id="page-form" method="post" action="{{ path('adminNewsDetailSave') }}" enctype="multipart/form-data">
        <input type="hidden" name="newsId" value="{{ news ? news.id : "0" }}">

        <div class="box multi-detail-box gg-form">
            <h3>{{ news ? (news.titleIt ~ ' - ' ~ news.titleEn) : 'Dettaglio notizia' }}</h3>
{#            <div class="secundary">{{ news ? "ID "~news.id }}</div>#}

            <div class="gg-multilang-form">
                <div>
                    <label>Titolo (italiano)</label>
                    <input type="text" name="titleIt" placeholder="Titolo (italiano)" value="{{ news ? news.titleIt }}">

                    <label>Corpo (italiano)</label>
                    <textarea name="bodyIt" class="tiny-area" placeholder="Scrivi qui il corpo della notizia (italiano)">{{ news ? news.bodyIt|raw }}</textarea>
                </div>

                <div>
                    <label>Titolo (inglese)</label>
                    <input type="text" name="titleEn" placeholder="Titolo (inglese)" value="{{ news ? news.titleEn }}">

                    <label>Corpo (inglese)</label>
                    <textarea name="bodyEn" class="tiny-area" placeholder="Scrivi qui il corpo della notizia (inglese)">{{ news ? news.bodyEn|raw }}</textarea>
                </div>
            </div>

        </div>

        <div class="box multi-detail-box gg-form">
            <h3>Immagine di copertina</h3>
            {% if news and news.hasCoverImage %}
                <img class="gg-admin-copertina" alt="Copertina notizia" src="{{ asset('uploads-news/'~news.id~'.webp') }}?v={{ random(1,9999) }}">
            {% endif %}
            <label>Carica immagine</label>
            <input type="file" name="coverImage" id="cover-image-input" accept="image/*">
            {% if news %}
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" id="upload-image-btn" class="gg-submit-btn hoverizzato" style="height: 36px;">Salva immagine</button>
                    {% if news.hasCoverImage %}
                        <button type="button" id="delete-image-btn" class="gg-delete-btn hoverizzato" style="height: 36px; border-radius: 8px;">Elimina immagine</button>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <div class="box multi-detail-box gg-form">
            <h3>Impostazioni</h3>

            <div class="gg-checkbox-group">
                <label>
                    <input type="checkbox" name="isPublic" value="1" {{ news and news.isPublic ? 'checked' }}>
                    <span>Notizia visibile pubblicamente</span>
                </label>

                <label>
                    <input type="checkbox" id="isEvent" name="isEvent" value="1" {{ news and news.isEvent ? 'checked' }} onchange="toggleEventDateTime()">
                    <span>È un evento</span>
                </label>
            </div>

            <div id="eventDateTimeContainer" style="{{ news and news.isEvent ? '' : 'display: none;' }}">
                <label>Data e ora evento</label>
                <input type="datetime-local" name="eventDatetime" id="eventDatetime" value="{{ news and news.eventDatetime ? news.eventDatetime|date('Y-m-d\\TH:i') }}">
            </div>

        </div>

        <button class="gg-submit-btn hoverizzato">Salva notizia</button>

    </form>

    {% if news and news.hasCoverImage %}
        <div id="delete-image-modal" class="gg-modal" style="display: none;">
            <div class="gg-modal-content">
                <p>Confermi di voler eliminare l'immagine di copertina?</p>
                <div class="gg-modal-buttons">
                    <button id="confirm-delete-image" class="gg-modal-btn gg-modal-btn--danger">Sì, elimina</button>
                    <button id="cancel-delete-image" class="gg-modal-btn gg-modal-btn--cancel">Annulla</button>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block js %}

    <script src="https://cdn.tiny.cloud/1/19quagaglhpufzna2p27cvo8kg2miu2f2flha91bl6aj5yqg/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>

    <script>
        function toggleEventDateTime() {
            const isEvent = document.getElementById('isEvent').checked;
            const container = document.getElementById('eventDateTimeContainer');
            container.style.display = isEvent ? 'block' : 'none';
        }
    </script>

    <script type="module">
        const fontUrl = '{{ asset("fonts/SofiaSans-VariableFont_wght.ttf") }}';
        tinymce.init({
            selector: 'textarea',
            menubar: false,
            toolbar: 'bold underline link bullist numlist removeformat',
            plugins: 'link | lists | paste',
            branding: false,
            paste_as_text: true,
            statusbar: false,
            content_style: `@font-face { font-family: "Sofia Sans"; src: url("${fontUrl}") format("truetype"); font-weight: 100 900; } body { font-family: "Sofia Sans", sans-serif; background-color: #F3F5F9; } body[data-mce-placeholder]:not(.mce-visualblocks)::before { opacity: 0.5; color: #999; font-size: 0.9rem; }`,
        });

        document.getElementById('page-form').addEventListener('submit', function(e) {
            e.preventDefault();
            tinymce.triggerSave(true, true);

            fetch('{{ path('adminNewsDetailSave') }}', {
                method: 'POST',
                body: new FormData(e.target)
            })
            .then(async response =>  {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message);
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                location.href = "{{ path('adminNewsList') }}";
            })
        });

        {% if news %}
        const uploadImageBtn = document.getElementById('upload-image-btn');
        const coverImageInput = document.getElementById('cover-image-input');

        uploadImageBtn.addEventListener('click', function(e) {
            e.preventDefault();

            if (!coverImageInput.files || !coverImageInput.files[0]) {
                alert('Seleziona prima un\'immagine');
                return;
            }

            const formData = new FormData();
            formData.append('coverImage', coverImageInput.files[0]);

            fetch('{{ path('adminNewsUploadImage', {'newsId': news.id}) }}', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message);
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                location.reload();
            });
        });

            {% if news.hasCoverImage %}
            const imageModal = document.getElementById('delete-image-modal');
            const deleteImageBtn = document.getElementById('delete-image-btn');
            const confirmImageBtn = document.getElementById('confirm-delete-image');
            const cancelImageBtn = document.getElementById('cancel-delete-image');

            deleteImageBtn.addEventListener('click', function(e) {
                e.preventDefault();
                imageModal.style.display = 'flex';
            });

            cancelImageBtn.addEventListener('click', function() {
                imageModal.style.display = 'none';
            });

            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    imageModal.style.display = 'none';
                }
            });

            confirmImageBtn.addEventListener('click', function() {
                imageModal.style.display = 'none';

                fetch('{{ path('adminNewsDeleteImage', {'newsId': news.id}) }}', {
                    method: 'DELETE'
                })
                .then(async response => {
                    let responseDecoded = await response.json();
                    if (!response.ok) {
                        alert(responseDecoded.message);
                        return null;
                    }
                    return responseDecoded;
                })
                .then(data => {
                    if (!data) {
                        return;
                    }
                    location.reload();
                });
            });
            {% endif %}
        {% endif %}
    </script>

{% endblock %}
