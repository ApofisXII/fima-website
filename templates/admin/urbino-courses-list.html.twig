{% extends 'admin/base.html.twig' %}

{% block body %}

    <div class="gg-h1">Corsi Urbino</div>

    <div class="gg-edition-tabs-wrapper">
        <div class="gg-edition-tabs">
            {% for edition in editions %}
                <button class="gg-edition-tab{% if edition.id == defaultEditionId %} active{% endif %}" data-edition-id="{{ edition.id }}">
                    {{ edition.editionName }}
                </button>
            {% endfor %}
        </div>
    </div>

    <div class="gg-list-actions">
        <a class="gg-btn gg-btn--plus hoverizzato" href="{{ path('adminUrbinoCoursesDetail') }}">+ Nuovo corso</a>
    </div>

    <p id="courses-tip" class="gg-tip">ðŸ’¡ Trascina le categorie e i corsi per riordinarli nel sito pubblico</p>

    <div id="categories-container"></div>

{% endblock %}

{% block js %}

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script type="module">
        let categoriesData = [];
        let openCategories = new Set();
        let isDragging = false;
        let isFirstLoad = true;

        async function loadData() {
            const activeTab = document.querySelector('.gg-edition-tab.active');
            const editionId = activeTab ? activeTab.dataset.editionId : '';
            const url = '{{ path('adminUrbinoCoursesListJson') }}' + (editionId ? '?editionId=' + editionId : '');
            const response = await fetch(url);
            const data = await response.json();
            categoriesData = data.categories;

            if (isFirstLoad) {
                categoriesData.forEach(cat => openCategories.add(cat.id));
                isFirstLoad = false;
            }

            renderCategories();
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';

            const isEmpty = categoriesData.length === 0;
            document.getElementById('courses-tip').style.display = isEmpty ? 'none' : '';

            if (isEmpty) {
                container.innerHTML = '<p class="gg-tip">Nessun corso presente per questa edizione</p>';
                return;
            }

            categoriesData.forEach((category, index) => {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'category-accordion';
                categoryEl.dataset.categoryId = category.id;
                categoryEl.dataset.index = index;

                const header = document.createElement('div');
                header.className = 'category-header';

                const isOpen = openCategories.has(category.id);
                const toggleClass = isOpen ? 'class="category-toggle open"' : 'class="category-toggle"';

                header.innerHTML = `
                    <span class="category-drag-handle">â‰¡</span>
                    <span class="category-name">${category.nameIt} / ${category.nameEn}</span>
                    <span class="category-count">${category.courses.length} ${category.courses.length === 1 ? 'corso' : 'corsi'}</span>
                    <span ${toggleClass}></span>
                `;

                const coursesContainer = document.createElement('div');
                coursesContainer.className = 'category-courses';
                coursesContainer.style.display = isOpen ? 'block' : 'none';

                if (category.courses.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'courses-table';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th class="reorder"></th>
                                <th>Docente</th>
                                <th>Materia</th>
                                <th>Date</th>
                                <th>Tipo</th>
                                <th>Stato</th>
                                <th>Creato</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody class="courses-tbody"></tbody>
                    `;

                    const tbody = table.querySelector('.courses-tbody');
                    category.courses.forEach(course => {
                        const row = document.createElement('tr');
                        row.dataset.courseId = course.id;
                        row.innerHTML = `
                            <td class="reorder"><span style="cursor: grab; font-size: 18px; color: dimgray">â‰¡</span></td>
                            <td>${course.teacherFullName}</td>
                            <td>${course.disciplineIt} / ${course.disciplineEn}</td>
                            <td>${course.dateRange}</td>
                            <td>${course.scheduleType === 'secondary_afternoon' ? '<span class="chip chip--event">Pomeridiano</span>' : '<span class="chip chip--neutral">Principale</span>'}</td>
                            <td>${course.isSoldOut ? '<span class="chip chip--deleted">Sold out</span>' : '<span class="chip chip--visible">Disponibile</span>'}</td>
                            <td>${course.createdAt}</td>
                            <td><a href="${course.courseDetailLink}" class="gg-table-btn">Modifica corso</a></td>
                        `;
                        tbody.appendChild(row);
                    });

                    coursesContainer.appendChild(table);

                    new Sortable(tbody, {
                        handle: '.reorder',
                        animation: 150,
                        onEnd: function(evt) {
                            handleCourseReorder(category.id, tbody);
                        }
                    });
                } else {
                    coursesContainer.innerHTML = '<p class="no-courses">Nessun corso in questa categoria</p>';
                }

                header.addEventListener('click', (e) => {
                    if (e.target.closest('.category-drag-handle')) return;
                    if (isDragging) return;

                    const isVisible = coursesContainer.style.display !== 'none';
                    const newState = !isVisible;

                    coursesContainer.style.display = newState ? 'block' : 'none';
                    header.querySelector('.category-toggle').classList.toggle('open', newState);

                    if (newState) {
                        openCategories.add(category.id);
                    } else {
                        openCategories.delete(category.id);
                    }
                });

                categoryEl.appendChild(header);
                categoryEl.appendChild(coursesContainer);
                container.appendChild(categoryEl);
            });

            new Sortable(container, {
                handle: '.category-drag-handle',
                animation: 150,
                onStart: function(evt) {
                    isDragging = true;
                },
                onEnd: function(evt) {
                    handleCategoryReorder();
                    setTimeout(() => {
                        isDragging = false;
                    }, 100);
                }
            });
        }

        async function handleCategoryReorder() {
            const container = document.getElementById('categories-container');
            const categoryElements = container.querySelectorAll('.category-accordion');

            const diff_categories = [];
            categoryElements.forEach((el, newIndex) => {
                const oldIndex = parseInt(el.dataset.index);
                const categoryId = parseInt(el.dataset.categoryId);

                if (oldIndex !== newIndex) {
                    diff_categories.push({
                        id: categoryId,
                        old_position: oldIndex,
                        new_position: newIndex
                    });
                }
            });

            if (diff_categories.length > 0) {
                await fetch('{{ path('adminUrbinoCategoriesReorder') }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ diff_categories })
                });

                await loadData();
            }
        }

        async function handleCourseReorder(categoryId, tbody) {
            const rows = tbody.querySelectorAll('tr');
            const diff_courses = [];

            rows.forEach((row, newIndex) => {
                const courseId = parseInt(row.dataset.courseId);
                diff_courses.push({
                    id: courseId,
                    new_position: newIndex,
                    old_position: newIndex
                });
            });

            await fetch('{{ path('adminUrbinoCoursesReorder') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ diff_courses })
            });
        }

        document.querySelectorAll('.gg-edition-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.gg-edition-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                isFirstLoad = true;
                loadData();
            });
        });

        loadData();
    </script>

{% endblock %}
