{% extends 'admin/base.html.twig' %}

{% block body %}

    <div class="gg-h1">Corsi Urbino</div>

    <div style="margin-bottom: 20px;">
        <a class="gg-btn gg-btn--plus hoverizzato" href="{{ path('adminUrbinoCoursesDetail') }}">+ Nuovo corso</a>
    </div>

    <table id="main-table">
        <thead>
        <tr>
            <th class="reorder"></th>
            <th>Docente</th>
            <th>Materia</th>
            <th>Edizione</th>
            <th>Stato</th>
            <th>Creata</th>
            <th></th>
        </tr>
        </thead>
    </table>

{% endblock %}

{% block js %}

    <script type="module">
        import DataTable from 'datatables.net-dt';
        import 'datatables.net-dt/css/dataTables.dataTables.min.css';

        const table = new DataTable("#main-table", {
            serverSide: true,
            ajax: {
                url: "{{ path('adminUrbinoCoursesListJson') }}",
            },
            ordering: false,
            drawCallback: function() {
                document.querySelectorAll('#main-table tbody tr').forEach(row => {
                    row.setAttribute('draggable', 'true');
                });
            },
            columns: [
                { data: "id", className: "reorder" },
                { data: "teacherFullName" },
                { data: "subjectIt" },
                { data: "editionName" },
                { data: "isSoldOut" },
                { data: "createdAt" },
                { data: "courseDetailLink" },
            ],
            columnDefs: [
                {
                    targets: 0, orderable: false, render: function(data, type, row) {
                        return '<div class="reorder-handle" data-id="'+data+'">' +
                               '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">' +
                               '<path d="M2 4h12M2 8h12M2 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' +
                               '</svg></div>';
                    }
                },
                {
                    targets: 4, render: function(data, type, row) {
                        return data ? "<span class='chip chip--deleted'>Sold out</span>" : "<span class='chip chip--visible'>Disponibile</span>";
                    }
                },
                {
                    targets: 6, render: function(data, type, row) {
                        return "<a href='"+data+"' class='gg-table-btn'>Modifica</a>";
                    }
                }
            ],
            pageLength: 25,
            language: {
                search: "Cerca:",
                lengthMenu: "Mostra _MENU_ risultati per pagina",
                info: "Mostrati da _START_ a _END_ di _TOTAL_ risultati",
                infoEmpty: "Nessun risultato disponibile",
                infoFiltered: "(filtrati da _MAX_ risultati totali)",
                paginate: {
                    first: "Primo",
                    last: "Ultimo",
                    next: "Successivo",
                    previous: "Precedente"
                },
                emptyTable: "Nessun dato disponibile nella tabella",
                zeroRecords: "Nessun risultato trovato"
            }
        });

        let draggedRow = null;

        document.addEventListener('dragstart', function(e) {
            if (e.target.closest('.reorder-handle')) {
                draggedRow = e.target.closest('tr');
                e.dataTransfer.effectAllowed = 'move';
                draggedRow.style.opacity = '0.5';
            }
        });

        document.addEventListener('dragend', function(e) {
            if (draggedRow) {
                draggedRow.style.opacity = '';
                draggedRow = null;
            }
        });

        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            if (draggedRow && e.target.closest('tbody tr')) {
                e.dataTransfer.dropEffect = 'move';
            }
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
            const targetRow = e.target.closest('tbody tr');

            if (draggedRow && targetRow && draggedRow !== targetRow) {
                const tbody = targetRow.parentNode;
                const allRows = Array.from(tbody.querySelectorAll('tr'));
                const draggedIndex = allRows.indexOf(draggedRow);
                const targetIndex = allRows.indexOf(targetRow);

                if (draggedIndex < targetIndex) {
                    targetRow.after(draggedRow);
                } else {
                    targetRow.before(draggedRow);
                }

                const orderedIds = Array.from(tbody.querySelectorAll('.reorder-handle')).map(el =>
                    parseInt(el.getAttribute('data-id'))
                );

                fetch("{{ path('adminUrbinoCoursesReorder') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderedIds: orderedIds })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Ordinamento salvato');
                    table.ajax.reload(null, false);
                })
                .catch(error => {
                    console.error('Errore durante il salvataggio:', error);
                    table.ajax.reload();
                });
            }
        });

    </script>

{% endblock %}
