{% extends 'admin/base.html.twig' %}

{% block body %}

    <div class="gg-h1">{{ course ? 'Modifica' : 'Nuovo' }} corso</div>

    <form id="page-form" method="post" action="{{ path('adminUrbinoCoursesDetailSave') }}" enctype="multipart/form-data">
        <input type="hidden" name="courseId" value="{{ course ? course.id : "0" }}">

        <div class="box multi-detail-box gg-form">
            <h3>{{ course ? (course.teacherFullName ~ ' - ' ~ (course.urbinoCourseCategory ? course.urbinoCourseCategory.nameIt : 'Senza categoria')) : 'Dettaglio corso' }}</h3>

            <div class="gg-form-row gg-form-row--two">
                <div class="gg-form-row__main">
                    <label>Docente</label>
                    <input type="text" name="teacherFullName" placeholder="Nome completo del docente" value="{{ course ? course.teacherFullName }}" required>
                </div>

                <div class="gg-form-row__year">
                    <label>Edizione</label>
                    <select name="urbinoEditionId" required>
                        <option value="">Seleziona edizione</option>
                        {% for edition in editions %}
                            <option value="{{ edition.id }}" {{ course and course.urbinoEdition and course.urbinoEdition.id == edition.id ? 'selected' }}>
                                {{ edition.editionName }} ({{ edition.year }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="gg-form-row gg-form-row--three">
                <div class="gg-form-row__year">
                    <label>Categoria</label>
                    <select name="urbinoCategoryId" id="category-select" required>
                        <option value="">Seleziona o crea categoria</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {{ course and course.urbinoCourseCategory and course.urbinoCourseCategory.id == category.id ? 'selected' }}>
                                {{ category.nameIt }} / {{ category.nameEn }}
                            </option>
                        {% endfor %}
                        <option value="__create_new__" style="font-weight: bold; color: var(--color-blue);">+ Crea nuova categoria</option>
                    </select>
                </div>

                <div class="gg-form-row__year">
                    <label>Tipo di corso</label>
                    <select name="scheduleType" required>
                        <option value="main" {{ course and course.scheduleType == 'main' ? 'selected' }}>Principale</option>
                        <option value="secondary_afternoon" {{ course and course.scheduleType == 'secondary_afternoon' ? 'selected' }}>Pomeridiano</option>
                    </select>
                </div>

                <div class="gg-form-row__year">
                    <label>Prezzo del corso (in €)</label>
                    <input type="number" name="priceEuros" step="0.01" min="0" placeholder="0.00" value="{{ course and course.priceCents ? (course.priceCents / 100)|number_format(2, '.', '') }}">
                </div>
            </div>

            <div class="gg-multilang-form">
                <div>
                    <label>Descrizione programma (italiano)</label>
                    <textarea name="programDescriptionIt" class="tiny-area" placeholder="Scrivi qui la descrizione del programma (italiano)">{{ course ? course.programDescriptionIt|raw }}</textarea>

                    <label>Biografia docente (italiano)</label>
                    <textarea name="bioDescriptionIt" class="tiny-area" placeholder="Scrivi qui la biografia del docente (italiano)">{{ course ? course.bioDescriptionIt|raw }}</textarea>
                </div>

                <div>
                    <label>Descrizione programma (inglese)</label>
                    <textarea name="programDescriptionEn" class="tiny-area" placeholder="Scrivi qui la descrizione del programma (inglese)">{{ course ? course.programDescriptionEn|raw }}</textarea>

                    <label>Biografia docente (inglese)</label>
                    <textarea name="bioDescriptionEn" class="tiny-area" placeholder="Scrivi qui la biografia del docente (inglese)">{{ course ? course.bioDescriptionEn|raw }}</textarea>
                </div>
            </div>

        </div>

        <div class="box multi-detail-box gg-form">
            <h3>Immagine docente</h3>
            {% if course and course.isImageUploaded %}
                <img class="gg-admin-copertina" alt="Foto docente" src="{{ asset('uploads-uma-courses/'~course.id~'.webp') }}?v={{ random(1,9999) }}">
            {% endif %}
            <label>Carica immagine</label>
            <input type="file" name="teacherImage" id="teacher-image-input" accept="image/*">
            {% if course %}
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" id="upload-image-btn" class="gg-submit-btn hoverizzato" style="height: 36px;">Salva immagine</button>
                    {% if course.isImageUploaded %}
                        <button type="button" id="delete-image-btn" class="gg-delete-btn hoverizzato" style="height: 36px; border-radius: 8px;">Elimina immagine</button>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <div class="box multi-detail-box gg-form">
            <h3>Impostazioni</h3>

            <div class="gg-checkbox-group">
                <label>
                    <input type="checkbox" name="isPreselectionRequired" value="1" {{ course and course.isPreselectionRequired ? 'checked' }}>
                    <span>Richiede preselezione</span>
                </label>

                <label>
                    <input type="checkbox" name="isSoldOut" value="1" {{ course and course.isSoldOut ? 'checked' }}>
                    <span>Sold out</span>
                </label>
            </div>

        </div>

        <div class="gg-btn-group">
            <button class="gg-submit-btn hoverizzato">Salva corso</button>
            {% if course %}
                <button id="delete-btn" class="gg-delete-btn hoverizzato">Elimina corso</button>
            {% endif %}
        </div>

    </form>

    {% if course %}
        <div id="delete-modal" class="gg-modal" style="display: none;">
            <div class="gg-modal-content">
                <p>Confermi di voler eliminare questo corso?</p>
                <div class="gg-modal-buttons">
                    <button id="confirm-delete" class="gg-modal-btn gg-modal-btn--danger">Sì, elimina</button>
                    <button id="cancel-delete" class="gg-modal-btn gg-modal-btn--cancel">Annulla</button>
                </div>
            </div>
        </div>

        {% if course.isImageUploaded %}
            <div id="delete-image-modal" class="gg-modal" style="display: none;">
                <div class="gg-modal-content">
                    <p>Confermi di voler eliminare l'immagine del docente?</p>
                    <div class="gg-modal-buttons">
                        <button id="confirm-delete-image" class="gg-modal-btn gg-modal-btn--danger">Sì, elimina</button>
                        <button id="cancel-delete-image" class="gg-modal-btn gg-modal-btn--cancel">Annulla</button>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <div id="create-category-modal" class="gg-modal" style="display: none;">
        <div class="gg-modal-content">
            <h3>Crea nuova categoria</h3>
            <form id="create-category-form">
                <div class="gg-modal-form-group">
                    <label>Nome categoria (italiano)</label>
                    <input type="text" id="new-category-name-it" placeholder="Nome italiano" required>
                </div>
                <div class="gg-modal-form-group">
                    <label>Nome categoria (inglese)</label>
                    <input type="text" id="new-category-name-en" placeholder="Nome inglese" required>
                </div>
                <div class="gg-modal-buttons">
                    <button type="submit" class="gg-modal-btn gg-modal-btn--primary">Crea categoria</button>
                    <button type="button" id="cancel-create-category" class="gg-modal-btn gg-modal-btn--cancel">Annulla</button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block js %}

    <script src="https://cdn.tiny.cloud/1/19quagaglhpufzna2p27cvo8kg2miu2f2flha91bl6aj5yqg/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>

    <script type="module">
        // Restore scroll position after reload
        const savedScrollPosition = sessionStorage.getItem('courseDetailScrollPosition');
        if (savedScrollPosition) {
            window.scrollTo(0, parseInt(savedScrollPosition));
            sessionStorage.removeItem('courseDetailScrollPosition');
        }

        // Category creation modal handling
        const categorySelect = document.getElementById('category-select');
        const createCategoryModal = document.getElementById('create-category-modal');
        const createCategoryForm = document.getElementById('create-category-form');
        const cancelCreateCategory = document.getElementById('cancel-create-category');
        let previousCategoryValue = categorySelect.value;

        categorySelect.addEventListener('change', function(e) {
            if (this.value === '__create_new__') {
                createCategoryModal.style.display = 'flex';
                document.getElementById('new-category-name-it').focus();
            } else {
                previousCategoryValue = this.value;
            }
        });

        cancelCreateCategory.addEventListener('click', function() {
            createCategoryModal.style.display = 'none';
            categorySelect.value = previousCategoryValue;
            document.getElementById('new-category-name-it').value = '';
            document.getElementById('new-category-name-en').value = '';
        });

        createCategoryModal.addEventListener('click', function(e) {
            if (e.target === createCategoryModal) {
                cancelCreateCategory.click();
            }
        });

        createCategoryForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const nameIt = document.getElementById('new-category-name-it').value;
            const nameEn = document.getElementById('new-category-name-en').value;

            fetch('{{ path('adminUrbinoCategoriesDetailSave') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    categoryId: 0,
                    nameIt: nameIt,
                    nameEn: nameEn
                })
            })
            .then(async response => {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message || 'Errore nella creazione della categoria');
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }

                // Ricarica le categorie per ottenere il nuovo ID
                fetch('{{ path('adminUrbinoCoursesDetail') }}?courseId={{ course ? course.id : 0 }}')
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newSelect = doc.getElementById('category-select');
                        const currentSelect = document.getElementById('category-select');

                        // Trova la nuova categoria
                        const newOptions = Array.from(newSelect.options).filter(opt =>
                            opt.text.includes(nameIt) && opt.value !== '__create_new__'
                        );

                        if (newOptions.length > 0) {
                            const newOption = newOptions[0];
                            // Inserisci la nuova opzione prima dell'opzione "Crea nuova categoria"
                            const createNewOption = currentSelect.querySelector('option[value="__create_new__"]');
                            const optionClone = document.createElement('option');
                            optionClone.value = newOption.value;
                            optionClone.textContent = newOption.text;
                            currentSelect.insertBefore(optionClone, createNewOption);

                            // Seleziona la nuova categoria
                            currentSelect.value = newOption.value;
                            previousCategoryValue = newOption.value;
                        }

                        // Chiudi modal e resetta form
                        createCategoryModal.style.display = 'none';
                        document.getElementById('new-category-name-it').value = '';
                        document.getElementById('new-category-name-en').value = '';
                    });
            })
            .catch(error => {
                alert('Errore: ' + error.message);
            });
        });

        const fontUrl = '{{ asset("fonts/SofiaSans-VariableFont_wght.ttf") }}';
        tinymce.init({
            selector: 'textarea',
            menubar: false,
            toolbar: 'bold underline link bullist numlist removeformat',
            plugins: 'link | lists | paste',
            branding: false,
            paste_as_text: true,
            statusbar: false,
            content_style: `@font-face { font-family: "Sofia Sans"; src: url("${fontUrl}") format("truetype"); font-weight: 100 900; } body { font-family: "Sofia Sans", sans-serif; background-color: #F3F5F9; } body[data-mce-placeholder]:not(.mce-visualblocks)::before { opacity: 0.5; color: #999; font-size: 0.9rem; }`,
        });

        document.getElementById('page-form').addEventListener('submit', function(e) {
            e.preventDefault();
            tinymce.triggerSave(true, true);

            fetch('{{ path('adminUrbinoCoursesDetailSave') }}', {
                method: 'POST',
                body: new FormData(e.target)
            })
            .then(async response =>  {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message);
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                location.href = "{{ path('adminUrbinoCoursesList') }}";
            })
        });

        {% if course %}
        const modal = document.getElementById('delete-modal');
        const deleteBtn = document.getElementById('delete-btn');
        const confirmBtn = document.getElementById('confirm-delete');
        const cancelBtn = document.getElementById('cancel-delete');

        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            modal.style.display = 'flex';
        });

        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        confirmBtn.addEventListener('click', function() {
            modal.style.display = 'none';

            fetch('{{ path('adminUrbinoCoursesDelete', {'courseId': course.id}) }}', {
                method: 'DELETE'
            })
            .then(async response => {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message);
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                location.href = "{{ path('adminUrbinoCoursesList') }}";
            });
        });

        const uploadImageBtn = document.getElementById('upload-image-btn');
        const teacherImageInput = document.getElementById('teacher-image-input');

        uploadImageBtn.addEventListener('click', function(e) {
            e.preventDefault();

            if (!teacherImageInput.files || !teacherImageInput.files[0]) {
                alert('Seleziona prima un\'immagine');
                return;
            }

            const formData = new FormData();
            formData.append('teacherImage', teacherImageInput.files[0]);

            fetch('{{ path('adminUrbinoCoursesUploadImage', {'courseId': course.id}) }}', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                let responseDecoded = await response.json();
                if (!response.ok) {
                    alert(responseDecoded.message);
                    return null;
                }
                return responseDecoded;
            })
            .then(data => {
                if (!data) {
                    return;
                }
                sessionStorage.setItem('courseDetailScrollPosition', window.scrollY);
                location.reload();
            });
        });

            {% if course.isImageUploaded %}
            const imageModal = document.getElementById('delete-image-modal');
            const deleteImageBtn = document.getElementById('delete-image-btn');
            const confirmImageBtn = document.getElementById('confirm-delete-image');
            const cancelImageBtn = document.getElementById('cancel-delete-image');

            deleteImageBtn.addEventListener('click', function(e) {
                e.preventDefault();
                imageModal.style.display = 'flex';
            });

            cancelImageBtn.addEventListener('click', function() {
                imageModal.style.display = 'none';
            });

            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    imageModal.style.display = 'none';
                }
            });

            confirmImageBtn.addEventListener('click', function() {
                imageModal.style.display = 'none';

                fetch('{{ path('adminUrbinoCoursesDeleteImage', {'courseId': course.id}) }}', {
                    method: 'DELETE'
                })
                .then(async response => {
                    let responseDecoded = await response.json();
                    if (!response.ok) {
                        alert(responseDecoded.message);
                        return null;
                    }
                    return responseDecoded;
                })
                .then(data => {
                    if (!data) {
                        return;
                    }
                    sessionStorage.setItem('courseDetailScrollPosition', window.scrollY);
                    location.reload();
                });
            });
            {% endif %}
        {% endif %}
    </script>

{% endblock %}
